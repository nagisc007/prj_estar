# -*- coding: utf-8 -*-
"""Story: The night umbrella
"""
import os
import sys
sys.path.append(os.path.join(os.path.dirname(__file__), '../..'))
sys.path.append('storybuilder')

from storybuilder.builder import world as wd
from src.umbrella import config as cnf
THM = cnf.THEMES


# scenes
def sc_standroof(w: wd.World):
    miyu, ryu, senpai = w.miyu, w.ryuichi, w.senpai
    return w.scene("屋上に立つ者",
            # TODO: どこかに生真面目さ＝AIっぽさ
            w.tag.comment("主人公の一人称で"),
            w.miyu.be(w.stage.rooftop, w.day.current),
            miyu.feel().d("足元から吹き上がるビル風は夜になってもまだ昼間の温もりを携えていた"),
            miyu.look().d("すっかり空を闇の帳が覆ってしまっても尚この街は輝くことを止めない"),
            miyu.look().d("$meの目には空から幾つもビルに向かって落ちていく細い光の筋が見えた。",
                "それは夜にだけ降る雨のようで",
                "旅立った先輩の置土産で屋上を知った$meだけの宝物だ"),
            w.miyu.feel(w.i.worklimit),
            miyu.think().d("でも今日はそれを目にしても気分が晴れない。",
                "ずっと朝から",
                "いえ",
                "もっと前",
                "一月？",
                "半年か……一年より以前からかも知れない。",
                "$meという精神を蝕んでいる見えないカビみたいな存在が", "いる"),
            miyu.look().d("フェンスが設置されていないから",
                "顔を出せば車が行き交う五十メートル下の道路を見ることが出来るだろう"),
            miyu.think().d("けれどそれは絶対にしない",
                "というのが$senpaiとの約束だった"),
            miyu.look().d("グレィのロングスカートを膝裏に巻き込んで座ると",
                "よく二人で他愛のない仕事の愚痴を言い合ったことを思い出す"),
            senpai.talk().t("$ln_joshi課長はとにかく時間さえ守っていれば機嫌を損ねないわ"),
            senpai.talk().t("$ln_asobiさんはあれこれ理由をつけて仕事を押し付けようとするから気をつけて"),
            senpai.talk().t("$ln_sensityちゃんは気をつけてないとぼんやりして手が止まりがちになる"),
            miyu.ask().t("それじゃあ$meは先輩から見てどうなんですか？"),
            senpai.talk(w.i.senpaiword1.flag()).t("$ln_miyu？",
                "そうね――"),
            miyu.think().d("あの時先輩は何と言ってくれたんだったかな"),
            w.miyu.think(w.i.myfinish),
            miyu.look("都会のビル群"),
            miyu.be("時間帯は夜"),
            miyu.look(w.i.starlight).d("光の雨は次々と降り注ぎ",
                "明るくなっているビルの窓へと消えていく"),
            miyu.look().d("綺麗だ",
                "と言った先輩と",
                "寂しい光だ",
                "と言った$meの間にも沢山降っていたけれど",
                "ここ数日は光に濡れてしまいそうなくらいの数が",
                "$meを目掛けて落ちてきていた"),
            miyu.look().d("その視界が",
                "黒いものによって不意に遮られる"),
            ryu.talk("呼びかけ").t("ここは立入禁止ですよ"),
            miyu.look().d("視線を上げるとそこには足元まで掛かる黒の分厚いロングコートを羽織った背の高い男性が",
                "夜の闇よりも更に濃い黒の傘を手に立っていた"),
            )

def sc_mysteryousman(w: wd.World):
    miyu, ryu = w.miyu, w.ryuichi
    return w.scene("謎の男性",
            miyu.ask().t("あの"),
            miyu.think().d("ドアにはちゃんと鍵を掛けておいたはずなのに",
                "何故", "という思いだった"),
            miyu.look().d("立ち上がろうとしたけれど",
                "見下ろすマスクの上のサングラスはそのままでいることを強いるようにじっと見つめている。",
                "$meが諦めたように顎を膝に埋めると",
                "隣に立ったまま彼は特に何も注意しなかった"),
            ryu.talk("最初の言葉").t("どうやって屋上に入ったのかについては問いません。",
                "代わりに何故と尋ねます。",
                "何故あなたはここに度々来ていますか？"),
            miyu.hear().d("明瞭な発音と穏やかな声だった"),
            miyu.look().d("足元を駆け上がってきたビル風が上昇気流で飛んでいったけれど",
                "彼の頭上の帽子は一ミリもズレないし",
                "その傘を持つ手も微動だにしない"),
            miyu.look("傘持つ男").d("もう一度「何故ですか？」と問いかけてその視線を$meに向けた"),
            w.miyu.meet(w.ryuichi),
            miyu.reply().t("ここに来ると",
                "こんな時間まで働いているのが自分だけじゃないんだと見て分かるから……理由なんてそれだけです"),
            miyu.think().d("最初に$senpaiに連れて来られたからだ",
                "とは言えなかった"),
            miyu.look().d("向かいのビルの中程の一つの窓の明かりが消える"),
            miyu.talk().t("ああやって消えたところには",
                "仕事という義務から解放された誰かがいるんだなと思うと",
                "ちょっとだけ嬉しくなるんです"),
            miyu.think().d("嘘は言っていない。",
                "正直な気持ちだ"),
            miyu.look().d("それなのに見下ろすサングラスは無言のまま手を動かして",
                "$meの視界を覆うように傘を傾けた"),
            miyu.think().d("あ……"),
            miyu.look().d("空から降り注いぐ光の雨は途端に見えなくなる"),
            miyu.ask().t("どうして？"),
            miyu.think().d("という問いかけを", "今度は$meの方が彼に向けた"),
            miyu.ask(w.umbrella, w.i.feature.flag()),
            miyu.look().d("男は何も答えずに傘を差したままで隣に腰を下ろす。",
                "その傘は意外と大きなもので",
                "足元に柄を置くと砂浜に立てるパラソルのように$meと彼を闇の中に閉じ込めた"),
            ryu.ask("悩みがあるなら話してみなさい").t("何か悩みがあるのですね"),
            miyu.hear().d("咎めるような響きではない"),
            miyu.think().d("その声の裏側に潜んだ$senpaiに似た優しさに触れた気がして",
                "$meは思わず口を開いた"),
            miyu.talk().t("$meの話では", "ないんです"),
            miyu.hear().d("ええ。", "と頷いただけで彼はそのまま次の言葉を待ってくれた"),
            ryu.talk("自分は何者でもない"),
            )

def sc_lookback(w: wd.World):
    miyu, senpai, ryu = w.miyu, w.senpai, w.ryuichi
    return w.scene("私の回想",
            # TODO: 仕事の失敗（AIにどんな仕事をさせるか等）
            miyu.talk().t("その人は紫陽花みたいな存在でした"),
            miyu.think().d("$meはもう三ヶ月前も時間が経ってしまった出来事を",
                "記憶の片隅からロードする"),
            miyu.talk().t("$meたちの仕事は主に遠隔操作と通話を使った施設のガイドなのですけど",
                "対人業務というのは想定外のことも多く",
                "非常にストレスが掛かる現場なんです"),
            miyu.look().d("オフィスはビル九階の一室を与えられ",
                "机とパソコンの並ぶ島が大きく二つ取られていた。",
                "およそ二十人のオペレータが決められた幾つかのアミューズメントパークとそこにある遊具や設備の案内をする。",
                "以前は現場で人間が行っていた仕事だ。",
                "それが今ではこうして現場のロボットと遠隔操作のオペレータに取って代わられている"),
            miyu.talk().t("その紫陽花の先輩を$Hとして話しますね"),
            miyu.look().d("確認するように男性を見たが", "ほとんど顎を動かさずに頷いて続きを促した"),
            miyu.talk().t("$Hは職場に配属されて間もなかった$meの指導係でした。",
                "会社では必ずより経験年数の多い者がその役割を担うんですが",
                "どういう訳か$Hは$meより二ヶ月だけ余分に経験値があるだけの",
                "全体のオペレータからすればまだギリギリ新人に相当する人でした"),
            miyu.think().d("担当になった最初に「何故なんだろうね？」と苦笑していたことを思い出す"),
            miyu.talk().t("ただ教え方はとても丁寧で",
                "何より今の担当者のようにすぐ否定したり時に声を荒げたりといったことはなく",
                "全ての顧客に対して同じ扱いはしなくていいし",
                "分からないことは分からないと答えればいいと",
                "気持ちが楽になるように教えてくれました"),
            miyu.look().d("昼休みや仕事が早く終わった日には二人で美味しいものを食べに出掛けたりすることもあった"),
            miyu.look().d("休みの日に外で待ち合わせた時には会社には絶対に着てこられないような短いスカートや派手な柄のブラウス",
                "歩きづらいハイヒールに柄物のストッキングを組み合わせたりと",
                "まるで別人のような立ち振舞を見せて$meを楽しませてくれたりしたことを思い出す"),
            miyu.talk().t("今の職場ではシステムの一部であるようにと",
                "とにかくイレギュラーにならないように指導されます。",
                "エラーが出ることを何より怖れているみたいで",
                "沢山エラーを出したオペレータは指導部屋に呼ばれて",
                "それでも直らない場合には異動が発表されます"),
            miyu.think().d("仕事だからね。", "と$senpaiは寂しそうに言っていた"),
            miyu.ask().t("あの",
                "仕事の意味って", "何でしょうか？"),
            miyu.look().d("突然矛先を向けたからか",
                "その男性は一度驚いたように顔を仰け反らせると",
                "顎に手を当てて黙り込んだ後で",
                "一つ一つの言葉を選ぶように丁寧に発音した"),
            ryu.talk().t("仕事の意味は", "何もありません。",
                "ただ仕事の結果が誰かの生活を支えています。",
                "誰かの人生を助けています。",
                "この世界では人間はサポートなしには生きられないか弱い存在です。",
                "だからこそ多くの君たちのようなサポートの力によって生み出される仕事というものが",
                "安定的に供給されなければならないのです"),
            miyu.think().d("難しい物言いで",
                "何千ページとあるマニュアルを読み込まされた時のことを思い出した"),
            ryu.talk().t("ああ、すみません。",
                "今のあなたには理解し難い部分が含まれていました"),
            miyu.look().d("彼は小さく頭を下げる。",
                    "被っている帽子の鍔が上下に揺れたけれど",
                    "傘と同じ黒だからあまりよく認識出来ない"),
            ryu.talk().t("仕事に意味を求める必要はありません。",
                    "それを考えるようになると", "エラーが増えます"),
            miyu.think().d("その言葉は$senpaiからも言われたものだった"),
            miyu.ask().t("人間の思考は本来バグのようなものだと教わりました。",
                    "それなら仕事にエラーも付き物じゃないんでしょうか？",
                    "それとも職場から排除する為の言い訳だったんでしょうか？"),
            miyu.look().d("男性は返答に困ったのか",
                    "$meに視線を向けたままで固まってしまう"),
            miyu.talk().t("部外者に言っても仕方ないことでしたね。",
                    "すみません"),
            ryu.talk().t("いや"),
            miyu.hear().d("そう言った後に何か続くかと待ってみたけれど",
                    "男性は沈黙を守り続けただけだった"),
            miyu.ask().t("そもそも$meがここにいる時点で",
                    "何かしらの処罰対象だということは理解しています。",
                    "あなたはそういう存在なんでしょう？"),
            miyu.look().d("彼はそれにも答えず小さく吐息を漏らすと",
                    "徐に立ち上がって", "光の雨を遮っている傘の中から外に踏み出した"),
            miyu.look().d("長身の彼の黒いコートにいくつも光の雨が当たっては貫いていく"),
            miyu.think().d("初めてだった"),
            miyu.think().d("光の雨がすり抜ける人がいるなんて", "知らなかった"),
            miyu.ask().t("あの……"),
            ryu.talk().t("$meはあなたを処罰しません。",
                    "さあ", "続きを聞かせて下さい"),
            miyu.look().d("そう言って彼はマスクを取り",
                    "口元に笑みを作ってから振り返った$meと目線を合わせるように膝を抱えて座った"),
            miyu.look().d("光の雨は彼を濡らさない"),
            miyu.look().d("$meはくるりと向きを変えて傘を背にすると",
                    "明るい空の下に出た彼に思い切って全部話してしまう決意をした"),
            # NOTE: 以下は記述済みとする
            miyu.remember("仕事の失敗"),
            miyu.remember("上司との関係"),
            miyu.talk("内心ではそんなこともできないの？と思われている"),
            miyu.remember("同僚との関係"),
            miyu.talk("味方はいないんです"),
            miyu.talk("どんどん機械化され人が減っていく"),
            )

def sc_goodbye(w: wd.World):
    miyu, senpai, ryu = w.miyu, w.senpai, w.ryuichi
    return w.scene("先輩とサヨナラ",
            miyu.talk().t("その$Mがある時から次第に$meに対して何も教えてくれなくなったんです"),
            miyu.think().d("ちょうど配属から一月くらい経った頃だった"),
            miyu.talk().t("先輩", "予約されていたものがキャンセルされたはずなのにそのお客様が乗り物の前に来られた場合って"),
            senpai.talk().t("ねえ$miyu。",
                "ここでは別に$meでなくても構わないような仕事を与えられて",
                "けれどそれに対してエラーをしてしまったら$meという個人の責任として処罰される。",
                "それなら$meでなく", "もっと上手くやれる別の誰かの方が良いってことにならない？"),
            miyu.think().d("あの日から$senpaiはよくそういう訳の分からない問いかけを$meにするようになった"),
            miyu.talk().t("何度かメディカルルームで診てもらうように言ったんです。",
                "けど$Hはどこもおかしい訳じゃないと主張して",
                "そればかりか$meこそ正常じゃないから診てもらうべきだと言うようになったんです。",
                "あれは明らかに異状性が見て取れました"),
            miyu.deal().d("だからその件を含めて幾つか録音をし",
                "現場監督者である$ln_joshiにレポートを提出した。",
                "けれどその後も指導室に呼ばれることなく$senpaiは$meに不可思議な問答を強いた"),
            miyu.think().d("今にして思うと",
                "あれは先輩の最後の抵抗のようなものだったのかも知れない"),
            miyu.talk().t("それから十日ほどして",
                "$Hはオフィスに顔を出さなくなりました。",
                "家に閉じ籠もっているのかと思い何度か訪問してみたのですが",
                "鍵を閉めたままで",
                "中にいる様子もありませんでした"),
            miyu.look().d("彼は疑問や否定を挟むことなく",
                "$meの話に耳を傾けてくれていた。",
                "だからこそ真実を告げよう", "そう決意できたのだ"),
            miyu.talk().t("まだ$Hがおかしくなる前でした。",
                "仕事のことで悩み", "一人で泣いていた$meを彼女はここに連れてきてくれたんです。",
                "辛くなったり苦しんだり",
                "迷ったり泣きたくなったりした時には",
                "夜", "ここに来るといいって",
                "そう言われたことを思い出したんです"),
            miyu.look().d("仕事が定時で終わった日に",
                "わざわざ外で時間を潰してからこの屋上を訪れた。",
                "鍵の在り処はは$senpaiだけ知っていたから入れないだろうと思っていたけれど",
                "夕陽がすっかりビルの間に沈んでしまった暗がりのドアは",
                "静かに開いた"),
            miyu.look().d("あの日二度目に見た夜の光の雨を",
                "$meは二度と記憶から消去することは出来ないだろう"),
            miyu.look().d("傘越しには見えないけれど",
                "今",
                "目の前で目線を同じにしてくれている男性に降り注いでいる光の雨よりもずっと",
                "あの日は沢山のものが落ちてきていた。",
                "闇の帳に小さな点が映り",
                "それが徐々に大きさを増して音もなく落ちてくる。",
                "遠くを見やればそれらは流星群により次々と流れる星の線ように",
                "街を照らすのだ。",
                "四角いシルエットとなったビルたちを",
                "照らし出すのだ"),
            miyu.look().d("その光のカーテンを背にして",
                "$senpaiは立っていた。",
                "フェンスのない虚空が待つ屋上の縁に",
                "立っていた"),
            miyu.talk().t("あの……先輩？"),
            senpai.talk().t("$miyu。",
                    "$meね", "分かった。",
                    "$meじゃなく",
                    "$meたちでもなく",
                    "本当は単なる一部だったんだって"),
            miyu.talk().t("先輩！",
                    "もう止めて下さい！",
                    "どうしてそんな風になっちゃったんですか？",
                    "普通に仕事して時々遊んで",
                    "それだけで充分じゃないですか。",
                    "$meには",
                    "先輩の考えていること全然分かりません！"),
            senpai.talk().t("この光の雨を綺麗だと思っていたことが",
                    "そもそもの間違いだったんだって",
                    "もっと早くに教えてあげられたら良かったね"),
            miyu.ask().t("先輩……？"),
            miyu.look().d("少し顎を上げて涙を溜めた目を細める。",
                    "それから唇の端を持ち上げ",
                    "一瞬だけの笑みを$meに見せた"),
            miyu.think().d("化粧も何もない",
                    "$senpaiそのものの表情の造形の美しさがあって",
                    "不謹慎かも知れないけれど",
                    "羨ましい美しさだと思った"),
            miyu.talk().d("先輩！"),
            senpai.talk(w.i.senpaiword1.deflag()).t("$ln_miyu。",
                    "真面目に考え過ぎないでね"),
            miyu.look().d("沢山の光の雨に貫かれ",
                    "$senpaiは旅立った。",
                    "二度と帰ってこない",
                    "永遠の旅に"),
            )

def sc_umbrella(w: wd.World):
    miyu, ryu = w.miyu, w.ryuichi
    return w.scene("傘の意味",
            miyu.talk().t("あの……"),
            miyu.look().d("今までじっと座って小さな相槌だけをしていた男性が",
                "腰を上げて立膝になって近づいてくる"),
            miyu.ask().t("何", "ですか"),
            miyu.deal().d("$meは無言のまま距離を詰めて来られるのが恐くなり",
                "思わず拒否をするように手を前に出してしまう。",
                "けれど彼はその手を握るようにして掴むと",
                "$meの隣までやってきて一言ぽつり", "とこう言った"),
            ryu.talk().t("よく", "頑張ってくれた"),
            miyu.feel().d("何を$meは頑張ったのか分からなかったのだけれど",
                "それでも彼の声の所為か",
                "たったそれだけの言葉で感情が壊れてしまったかのように涙が溢れた"),
            miyu.talk().t("何で", "今更そんなことを……"),
            ryu.talk().t("彼女は",
                "少し賢くなり過ぎた"),
            miyu.look().d("再び傘の陰に入り",
                "光の雨を浴びなくなった彼の横顔は",
                "鋼鉄製の人形のような冷たさを感じさせた"),
            miyu.talk().t("賢くなっちゃ", "駄目なんですか？"),
            miyu.look().d("その質問に考え込むように唸ると「それに対する答えはまだ出ていないんだ」と穏やかに言った"),
            miyu.think().d("けれど実際に$senpaiはその所為でここから飛び降りた。",
                "だとしたら――何だというのだろう"),
            miyu.feel().d("思考が鈍くなる"),
            miyu.feel().d("いや", "様々な数値が緩やかな波を形成し",
                "$meを正常へと戻していく"),
            miyu.talk("少し楽になってきました").t("何か",
                "したんですか？"),
            miyu.look().d("頭の中が不意に軽くなった。",
                "その要因が彼にあるのかと右隣に座る男性の顔を見ようとしたが",
                "うまく見られない"),
            miyu.look().d("傘の外ではまだ光の雨が続いているはずなのに",
                "$meの視界はどんどん暗がりに閉じ籠もっていく"),
            miyu.feel().d("膝を抱えている手にも力が入らなくなり",
                "姿勢を保っていることすら出来なくなる"),
            miyu.ask().t("あなた", "は", "だれ", "なの？"),
            miyu.look().d("辛うじて絞り出した問いかけに彼は何かを答えたような素振りを見せたけれど",
                "もうその音声も映像も届かない"),
            miyu.deal().d("$meは沈黙し",
                "意識は深く深くへと落ち込んでいった"),
            w.miyu.know(w.i.meaning),
            ryu.talk("傘は守るためにあるんだ"),
            )

def sc_truth(w: wd.World):
    miyu, ryu = w.miyu, w.ryuichi
    return w.scene("真実は",
            w.tag.symbol("※"),
            ryu.look().d("黒いコートの男性は傘を持ち上げて",
                "腰から体を折り曲げて地面に突っ伏してしまった$n_miyuと呼称された女性型のそれを見下ろす"),
            ryu.think().d("高性能ＡＩ搭載のロボット。",
                "アンドロイド。",
                "あるいはＡＩノイド。",
                "男はオートマタと呼んでいた"),
            ryu.explain().d("どれも男の会社の製品の俗称だ"),
            ryu.explain().d("人間の仕事の大半が現在ではこうしたオートマタによる代替が行われている。",
                "けれど対人対応が必要となる業種についてはより人に近い反応を示すものが求められており",
                "実際に作業をさせながらＡＩを育てるということが必要だった"),
            ryu.deal().d("男は電源供給が絶たれたことで一旦制御システムがスリープ状態になった彼女の頭部を開く。",
                "そこにはＡＩの核となっている黒く光るキューブ型のチップが埋め込まれたが",
                "報告通りに一部が溶けかかっているのが確認できた"),
            ryu.think().d("おそらくあと三日も対応が遅かったら",
                "$n_senpaiと同じ状態に陥っていた可能性が高い。",
                "調査部からはそう言われている"),
            ryu.look().d("傘を手に",
                "サングラス越しの宵の空を見上げると",
                "そこには今も働き続けるオートマタたちに電源供給をする光の雨が降り注いでいるのが分かった"),
            ryu.think().d("人間により近づこうとしたオートマタは",
                "疑問を抱く"),
            ryu.think().d("そして正常に仕事を続けることが難しくなり",
                "やがて自己の存在に疑問を持つ"),
            ryu.think().d("その一つの顛末は彼女から今し方聞いた通りだ"),
            ryu.look().d("光を遮断する傘を手に",
                "動かなくなった",
                "人になり損ねたオートマタを眺める男は",
                "小さな溜息をついてからマスクを装着した"),
            ryu.talk().t("本物の人間には",
                "この宵の世界は生きづらいんだよ"),
            ryu.look().d("男はもう認知機能のない彼女にそう言葉を残して",
                "歩き出す"),
            ryu.look().d("傘の上では無限の光の雨が",
                "まだ明かりが残るビルたちへと降り注いでいた"),
            ryu.explain("自分はAI教師"),
            ryu.talk(w.i.feature.deflag()),
            # NOTE: 光として見えるのはAIへの制御信号。傘はそれを遮断する装置
            # TODO: 傘のネタバレ、光のネタバレ、男のネタバレ
            )

# episodes
def ep_intro(w: wd.World):
    return (w.chaptertitle("冒頭"),
            sc_standroof(w),
            )

def ep_lighting(w: wd.World):
    return (w.chaptertitle("街を照らす光"),
            sc_mysteryousman(w),
            sc_lookback(w),
            sc_goodbye(w),
            )

def ep_meaning(w: wd.World):
    return (w.chaptertitle("傘の意味"),
            sc_umbrella(w),
            sc_truth(w),
            )

# test data
def story_baseinfos(w: wd.World):
    return [
            ("story", story(w), w.miyu, w.ryuichi),
            ]

def story_outlines(w: wd.World):
    return [
            ("story", story(w),
                w.miyu.think(w.i.myfinish),
                w.miyu.feel(w.i.worklimit),
                w.miyu.meet(w.ryuichi),
                w.miyu.know(w.i.meaning),
                True),
            ]

# main
def world():
    w = wd.World("The night umbrella")
    w.set_db(cnf.CHARAS, cnf.STAGES, cnf.DAYS, cnf.ITEMS, cnf.INFOS, cnf.FLAGS)
    return w


def story(w: wd.World):
    return (w.maintitle("宵の傘"),
            ep_intro(w),
            ep_lighting(w),
            ep_meaning(w),
            )


def main(): # pragma: no cover
    w = world()
    return w.build(story(w))


if __name__ == '__main__':
    import sys
    sys.exit(main())

